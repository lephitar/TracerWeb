<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracer Token Interface</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&family=Open+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.10.0/dist/index.umd.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/ledgerhq__hw-transport-webusb/6.27.1/ledgerhq-hw-transport-webusb.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/ledgerhq__hw-app-eth/6.33.1/ledgerhq-hw-app-eth.min.js"></script>
    <style>
        :root {
            --primary-blue: #2c59fb;
            --bg-light: #f5f7ff;
            --bg-medium: #e8edff;
            --bg-dark: #dde5ff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-light: #718096;
            --card-bg: #ffffff;
            --shadow: rgba(44, 89, 251, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            font-weight: 400;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 50%, var(--bg-dark) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px var(--shadow);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-family: 'Comfortaa', sans-serif;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 8px 16px var(--shadow);
        }

        h3 {
            font-family: 'Comfortaa', sans-serif;
            font-weight: 600;
            margin-top: 0;
            color: var(--primary-blue);
        }

        .status {
            padding: 16px 24px;
            border-radius: 50px;
            margin-bottom: 30px;
            font-weight: 600;
            text-align: center;
            font-family: 'Comfortaa', sans-serif;
        }

        .status.connected {
            background: linear-gradient(135deg, #7FB800, #608B00);
            color: white;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }

        .status.disconnected {
            background: linear-gradient(135deg, #f6511d, #BD3E16);
            color: white;
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .info-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 8px 20px var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px var(--shadow);
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .wallet-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 16px;
            background: var(--card-bg);
            border: 2px solid var(--bg-medium);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Comfortaa', cursive;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            text-decoration: none;
            min-height: 100px;
            justify-content: center;
        }

        .wallet-button:hover {
            transform: translateY(-4px);
            border-color: var(--primary-blue);
            box-shadow: 0 12px 24px var(--shadow);
            background: linear-gradient(135deg, var(--primary-blue), #1e40af);
            color: white;
        }

        .wallet-button:active {
            transform: translateY(-2px);
        }

        .wallet-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .wallet-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .connection-section {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 24px;
            margin-bottom: 32px;
            box-shadow: 0 8px 20px var(--shadow);
        }

        .connection-section h3 {
            margin-top: 0;
            color: var(--primary-blue);
            padding-bottom: 16px;
            border-bottom: 2px solid var(--bg-medium);
            margin-bottom: 24px;
            text-align: center;
        }

        button {
            font-family: 'Comfortaa', cursive;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-blue), #1e40af);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(44, 89, 251, 0.3);
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(44, 89, 251, 0.4);
            background: linear-gradient(135deg, #1e40af, var(--primary-blue));
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, var(--text-light), #9ca3af);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 8px rgba(113, 128, 150, 0.2);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .input-group input {
            width: 100%;
            padding: 16px 24px;
            border: 2px solid var(--bg-medium);
            border-radius: 50px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Open Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(44, 89, 251, 0.1);
        }

        .input-group input::placeholder {
            color: var(--text-light);
        }

        .transaction-section {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 20px var(--shadow);
        }

        .transaction-section h3 {
            margin-top: 0;
            color: var(--primary-blue);
            padding-bottom: 16px;
            border-bottom: 2px solid var(--bg-medium);
            margin-bottom: 24px;
        }

        .contract-info {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: var(--bg-light);
            color: var(--text-secondary);
            padding: 16px;
            border-radius: 12px;
            word-break: break-all;
            border: 1px solid var(--bg-medium);
        }

        .error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid #f87171;
            color: #991b1b;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            font-weight: 500;
        }

        .success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid #34d399;
            color: #065f46;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            font-weight: 500;
        }

        .notice {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 500;
        }

        .notice code {
            background: rgba(146, 64, 14, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px;
            }

            h1 {
                font-size: 2em;
                flex-direction: column;
                gap: 10px;
            }

            .logo {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            <img src="tracerlogo.png" alt="Tracer Logo" class="logo">
            Tracer Token Interface
        </h1>

        <div class="notice">
            <strong>‚ö†Ô∏è Early prototype:</strong> Connect through your wallet to see your TRCR holdings. Test the hell
            out of it.
        </div>

        <div id="status" class="status disconnected">
            Not Connected to Wallet
        </div>

        <div class="connection-section" id="walletSelection">
            <h3>Choose Your Wallet</h3>
            <div class="wallet-grid">
                <div class="wallet-button" onclick="connectMetaMask()">
                    <div class="wallet-icon">ü¶ä</div>
                    <span>MetaMask</span>
                </div>
                <div class="wallet-button" onclick="connectWalletConnect()">
                    <div class="wallet-icon">üîó</div>
                    <span>WalletConnect</span>
                </div>
                <div class="wallet-button" onclick="connectCoinbase()">
                    <div class="wallet-icon">üîµ</div>
                    <span>Coinbase</span>
                </div>
                <div class="wallet-button" onclick="showLedgerOptions()">
                    <div class="wallet-icon">üîí</div>
                    <span>Ledger</span>
                </div>
                <div class="wallet-button disabled" title="Coming soon">
                    <div class="wallet-icon">üåà</div>
                    <span>Rainbow</span>
                </div>
                <div class="wallet-button disabled" title="Coming soon">
                    <div class="wallet-icon">üõ°Ô∏è</div>
                    <span>Trust Wallet</span>
                </div>
            </div>

            <!-- Ledger Options Modal -->
            <div id="ledgerModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
                <div
                    style="background: var(--card-bg); padding: 40px; border-radius: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin-top: 0; text-align: center; color: var(--primary-blue);">Connect Your Ledger</h3>
                    <p style="text-align: center; margin-bottom: 30px; color: var(--text-secondary);">For desktop users,
                        we recommend using MetaMask with your Ledger:</p>

                    <div
                        style="background: var(--bg-light); padding: 20px; border-radius: 16px; margin-bottom: 24px; border: 2px solid var(--primary-blue);">
                        <h4 style="margin: 0 0 12px 0; color: var(--primary-blue);">üèÜ Recommended: MetaMask + Ledger
                        </h4>
                        <ol style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px;">
                            <li>Connect Ledger to computer via USB</li>
                            <li>Open Ethereum app on Ledger</li>
                            <li>In MetaMask: Settings ‚Üí Advanced ‚Üí Preferred Ledger Connection</li>
                            <li>Connect Ledger account to MetaMask</li>
                            <li>Click "MetaMask" button above</li>
                        </ol>
                    </div>

                    <p style="text-align: center; margin: 20px 0; color: var(--text-light); font-size: 14px;">
                        Or try these alternatives:
                    </p>

                    <div style="display: grid; gap: 16px; margin-bottom: 30px;">
                        <div class="wallet-button" onclick="connectLedgerMobile()" style="margin: 0;">
                            <div class="wallet-icon">üì±</div>
                            <div style="text-align: center;">
                                <strong>Via Ledger Live Mobile</strong>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Scan QR code with phone
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="closeLedgerModal()"
                        style="width: 100%; background: linear-gradient(135deg, #6b7280, #4b5563);">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Network</h3>
                <div id="network">Auto-detect from MetaMask</div>
                <div class="contract-info">Supports Arbitrum One & Sepolia</div>
            </div>

            <div class="info-card">
                <h3>Contract Address</h3>
                <div class="contract-info" id="contractAddress">Connect wallet to view</div>
            </div>

            <div class="info-card">
                <h3>Total Supply</h3>
                <div id="totalSupply">Loading...</div>
                <div id="symbol"></div>
            </div>

            <div class="info-card">
                <h3>Your Address</h3>
                <div class="contract-info" id="userAddress">Not Connected</div>
            </div>

            <div class="info-card">
                <h3>Your Balance</h3>
                <div id="balance"></div>
                <div id="symbol"></div>
            </div>

            <div class="info-card">
                <h3>Permit Counter</h3>
                <div id="nonce"></div>
            </div>

            <div class="info-card">
                <h3>Your Voting Power</h3>
                <div id="votingPower">Loading...</div>
                <div id="symbol"></div>
            </div>

            <div class="info-card">
                <h3>Voting Power Holder</h3>
                <div id="delegates">Loading...</div>
            </div>
        </div>

        <div class="actions" id="connectedActions" style="display: none;">
            <button id="refreshBtn" onclick="refreshData()">Refresh Data</button>
            <button onclick="addTokenToWallet()" id="addTokenBtn">Add Token to Wallet</button>
            <button onclick="disconnectWallet()" id="disconnectBtn"
                style="background: linear-gradient(135deg, #ef4444, #dc2626);">Disconnect</button>
        </div>

        <div class="transaction-section">
            <h3>Transfer Tokens</h3>
            <div class="input-group">
                <label for="transferTo">Recipient Address:</label>
                <input type="text" id="transferTo" placeholder="0x..." />
            </div>
            <div class="input-group">
                <label for="transferAmount">Amount (TRCR):</label>
                <input type="number" id="transferAmount" placeholder="0.0" step="0.000000000000000001" />
            </div>
            <button onclick="transferTokens()" disabled id="transferBtn">Transfer</button>
        </div>

        <div class="transaction-section">
            <h3>Approve Allowance</h3>
            <div class="input-group">
                <label for="approveSpender">Spender Address:</label>
                <input type="text" id="approveSpender" placeholder="0x..." />
            </div>
            <div class="input-group">
                <label for="approveAmount">Amount (TRCR):</label>
                <input type="number" id="approveAmount" placeholder="0.0" step="0.000000000000000001" />
            </div>
            <button onclick="approveTokens()" disabled id="approveBtn">Approve</button>
        </div>

        <div class="transaction-section">
            <h3>Check Allowance</h3>
            <div class="input-group">
                <label for="allowanceOwner">Owner Address:</label>
                <input type="text" id="allowanceOwner" placeholder="0x... (leave empty for your address)" />
            </div>
            <div class="input-group">
                <label for="allowanceSpender">Spender Address:</label>
                <input type="text" id="allowanceSpender" placeholder="0x..." />
            </div>
            <button onclick="checkAllowance()" disabled id="checkAllowanceBtn">Check Allowance</button>
            <div id="allowanceResult"></div>
        </div>

        <div class="transaction-section">
            <h3>Permit via Signature</h3>
            <div class="input-group">
                <label for="permitSpenderAddress">Permit Spender:</label>
                <input type="text" id="permitSpenderAddress" placeholder="0x..." type="text" />
            </div>
            <div class="input-group">
                <label for="permitAmount">Amount: (TRCR)</label>
                <input type="text" id="permitAmount" placeholder="0.0" type="text" />
            </div>
            <div class="input-group">
                <label for="deadlineStr">Deadline (local time):</label>
                <input type="text" id="deadlineStr" type="datetime-local" />
            </div>

            <button onclick="signAndSubmitPermit()" disabled id="signAndSubmitBtn">Sign & Sumbit</button>
            <div id="signAndSubmitResult"></div>
        </div>

        <div class="transaction-section">
            <h3>Check Voting Power</h3>
            <div class="input-group">
                <label for="votingPowerAddress">Address:</label>
                <input type="text" id="votingPowerAddress" placeholder="0x... (leave empty for your address)" />
            </div>
            <button onclick="checkVotingPower()" disabled id="checkVotingPowerBtn">Check Voting Power</button>
            <div id="votingPowerResult"></div>
        </div>

        <div class="transaction-section">
            <h3>Delegate Voting Power</h3>
            <div class="input-group">
                <label for="delegateAddress">Delegatee Address:</label>
                <input type="text" id="delegateAddress" placeholder="0x... (leave empty to delegate to self)" />
            </div>
            <button onclick="delegateVotingPower()" disabled id="delegateBtn">Delegate</button>
            <div id="delegateResult"></div>
        </div>

        <div id="messages"></div>
    </div>

    <footer
        style="text-align: center; padding: 30px 20px; margin-top: 40px; color: var(--text-light); font-size: 14px; font-family: 'Open Sans', sans-serif;">
        ¬© 2025 Tracer. All rights reserved. Use at your own risk.
    </footer>

    <script>
        // Contract configuration - both networks
        const CONTRACTS = {
            421614: { // Arbitrum Sepolia
                address: '0x23fd096B2875A6dEccae8C688f44fAf0001E3Eef',
                name: 'Arbitrum Sepolia',
                chainIdHex: '0x66eee',
                rpcUrl: 'https://sepolia-rollup.arbitrum.io/rpc',
                blockExplorer: 'https://sepolia.arbiscan.io/',
                nativeCurrency: {
                    name: 'Arbitrum Sepolia Ether',
                    symbol: 'ETH',
                    decimals: 18
                }
            },
            42161: { // Arbitrum One (Mainnet)
                address: '0x0000000000000000000000000000000000000000', // Replace with actual mainnet address
                name: 'Arbitrum One',
                chainIdHex: '0xa4b1',
                rpcUrl: 'https://arb1.arbitrum.io/rpc',
                blockExplorer: 'https://arbiscan.io/',
                nativeCurrency: {
                    name: 'Ether',
                    symbol: 'ETH',
                    decimals: 18
                }
            }
        };

        let currentNetwork = null;
        let CONTRACT_ADDRESS = null;

        // ERC20 ABI with ERC20Votes and ERC20Permit functions
        const TOKEN_ABI = [
            // Standard ERC20
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function transferFrom(address from, address to, uint256 amount) returns (bool)",

            // ERC20Permit
            "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s)",
            "function nonces(address owner) view returns (uint256)",
            "function DOMAIN_SEPARATOR() view returns (bytes32)",

            // ERC20Votes
            "function getVotes(address account) view returns (uint256)",
            "function getPastVotes(address account, uint256 blockNumber) view returns (uint256)",
            "function getPastTotalSupply(uint256 blockNumber) view returns (uint256)",
            "function delegate(address delegatee)",
            "function delegateBySig(address delegatee, uint256 nonce, uint256 expiry, uint8 v, bytes32 r, bytes32 s)",
            "function delegates(address account) view returns (address)",
            "function checkpoints(address account, uint32 pos) view returns (tuple(uint32 fromBlock, uint224 votes))",
            "function numCheckpoints(address account) view returns (uint32)",

            // Events
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event Approval(address indexed owner, address indexed spender, uint256 value)",
            "event DelegateChanged(address indexed delegator, address indexed fromDelegate, address indexed toDelegate)",
            "event DelegateVotesChanged(address indexed delegate, uint256 previousBalance, uint256 newBalance)"
        ];

        let provider, signer, contract, userAccount, connectedWallet;

        // Wallet connection state
        let walletConnectProvider = null;

        function detectNetwork(chainId) {
            const networkId = parseInt(chainId);
            currentNetwork = CONTRACTS[networkId];

            if (currentNetwork) {
                CONTRACT_ADDRESS = currentNetwork.address;
                document.getElementById('network').textContent = currentNetwork.name;
                document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;
                return true;
            } else {
                currentNetwork = null;
                CONTRACT_ADDRESS = null;
                return false;
            }
        }

        function updateNetworkUI() {
            if (currentNetwork) {
                document.getElementById('network').textContent = currentNetwork.name;
                document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;

                // Show/hide mainnet warning
                const isMainnet = currentNetwork.name === 'Arbitrum One';
                let warning = document.getElementById('mainnetWarning');

                if (isMainnet && CONTRACT_ADDRESS === '0x0000000000000000000000000000000000000000') {
                    if (!warning) {
                        warning = document.createElement('div');
                        warning.id = 'mainnetWarning';
                        warning.className = 'error';
                        warning.innerHTML = '<strong>‚ö†Ô∏è Mainnet Warning:</strong> Please update the mainnet contract address in the code before using on Arbitrum One.';
                        document.querySelector('.container').insertBefore(warning, document.getElementById('status'));
                    }
                } else if (warning) {
                    warning.remove();
                }
            }
        }

        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showMessage('MetaMask is not installed! Please install MetaMask extension.', 'error');
                    return;
                }

                await connectWithProvider(window.ethereum, 'MetaMask');

            } catch (error) {
                console.error('MetaMask connection error:', error);
                handleConnectionError(error, 'MetaMask');
            }
        }

        async function connectWalletConnect() {
            try {
                showMessage('Initializing WalletConnect v2...', 'success');

                // Wait a moment to ensure the script is loaded
                await new Promise(resolve => setTimeout(resolve, 100));

                if (typeof window.EthereumProvider === 'undefined') {
                    throw new Error('WalletConnect provider not loaded. Please refresh the page and try again.');
                }

                walletConnectProvider = await window.EthereumProvider.init({
                    projectId: 'YOUR_PROJECT_ID', // Replace with your actual project ID
                    chains: [42161, 421614], // Arbitrum One and Sepolia
                    showQrModal: true,
                    methods: [
                        'eth_sendTransaction',
                        'eth_signTransaction',
                        'eth_sign',
                        'personal_sign',
                        'eth_signTypedData',
                    ],
                    events: ['chainChanged', 'accountsChanged'],
                    metadata: {
                        name: 'Tracer Token Interface',
                        description: 'Tracer Token DApp',
                        url: window.location.href,
                        icons: [`${window.location.origin}/tracerlogo.png`]
                    }
                });

                // Enable session (shows QR modal)
                await walletConnectProvider.enable();

                await connectWithProvider(walletConnectProvider, 'WalletConnect');

            } catch (error) {
                console.error('WalletConnect v2 connection error:', error);
                handleConnectionError(error, 'WalletConnect');
            }
        }

        async function connectCoinbase() {
            try {
                if (typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet) {
                    await connectWithProvider(window.ethereum, 'Coinbase Wallet');
                } else {
                    showMessage('Coinbase Wallet not detected. Please install Coinbase Wallet extension or use WalletConnect.', 'error');
                }
            } catch (error) {
                console.error('Coinbase connection error:', error);
                handleConnectionError(error, 'Coinbase Wallet');
            }
        }

        async function showLedgerOptions() {
            const modal = document.getElementById('ledgerModal');
            modal.style.display = 'flex';
        }

        function closeLedgerModal() {
            document.getElementById('ledgerModal').style.display = 'none';
        }

        async function connectLedgerMobile() {
            closeLedgerModal();
            try {
                showMessage('üì± Instructions: 1) Install Ledger Live on phone 2) Connect Ledger to phone 3) Open Ethereum app on Ledger 4) Scan QR code', 'success');

                // Wait a moment to ensure the script is loaded
                await new Promise(resolve => setTimeout(resolve, 100));

                if (typeof window.EthereumProvider === 'undefined') {
                    throw new Error('WalletConnect provider not loaded. Please refresh the page and try again.');
                }

                walletConnectProvider = await window.EthereumProvider.init({
                    projectId: 'YOUR_PROJECT_ID', // Replace with your actual project ID
                    chains: [42161, 421614],
                    showQrModal: true,
                    methods: ['eth_sendTransaction', 'eth_signTransaction', 'eth_sign', 'personal_sign'],
                    events: ['chainChanged', 'accountsChanged'],
                    metadata: {
                        name: 'Tracer Token - Ledger Connection',
                        description: 'Connect your Ledger via Ledger Live mobile',
                        url: window.location.href,
                        icons: [`${window.location.origin}/tracerlogo.png`]
                    }
                });

                await walletConnectProvider.enable();
                await connectWithProvider(walletConnectProvider, 'Ledger (Mobile)');

            } catch (error) {
                console.error('Ledger mobile connection error:', error);
                handleConnectionError(error, 'Ledger Mobile');
            }
        }

        // Legacy function for backward compatibility
        async function connectLedger() {
            showLedgerOptions();
        }

        async function connectWithProvider(providerInstance, walletName) {
            // Add a small delay to ensure provider is fully loaded
            await new Promise(resolve => setTimeout(resolve, 100));

            // Initialize ethers provider
            provider = new ethers.BrowserProvider(providerInstance);

            // Wait for provider to be ready
            await provider._detectNetwork();

            // Get current network
            const network = await provider.getNetwork();
            const isSupported = detectNetwork(network.chainId.toString());

            if (!isSupported) {
                showMessage(`Unsupported network. Please switch to Arbitrum One or Arbitrum Sepolia.`, 'error');
                updateNetworkUI();
                return;
            }

            signer = await provider.getSigner();
            userAccount = await signer.getAddress();
            connectedWallet = walletName;

            // Initialize contract with current network
            contract = new ethers.Contract(CONTRACT_ADDRESS, TOKEN_ABI, signer);

            updateUI();
            updateNetworkUI();
            await refreshData();

            showMessage(`Successfully connected to ${currentNetwork.name} via ${walletName}!`, 'success');
        }

        function handleConnectionError(error, walletName) {
            if (error.code === 4001) {
                showMessage(`${walletName} connection cancelled by user`, 'error');
            } else if (error.code === -32002) {
                showMessage(`${walletName} connection request already pending`, 'error');
            } else if (error.message.includes('origin')) {
                showMessage(`${walletName} origin error. Try refreshing the page or using a local server.`, 'error');
            } else {
                showMessage(`${walletName} connection failed: ${error.message}`, 'error');
            }
        }

        async function disconnectWallet() {
            try {
                if (walletConnectProvider && connectedWallet && connectedWallet.includes('WalletConnect') || connectedWallet.includes('Ledger')) {
                    await walletConnectProvider.disconnect();
                    walletConnectProvider = null;
                }

                // Reset all state
                provider = null;
                signer = null;
                contract = null;
                userAccount = null;
                connectedWallet = null;
                currentNetwork = null;
                CONTRACT_ADDRESS = null;

                // Reset UI
                updateUI();
                document.getElementById('balance').textContent = '0 TRCR';
                document.getElementById('totalSupply').textContent = 'Loading...';
                document.getElementById('nonce').textContent = '0';
                document.getElementById('network').textContent = 'Auto-detect from Wallet';
                document.getElementById('contractAddress').textContent = 'Connect wallet to view';

                // Clear any warning messages
                const warning = document.getElementById('mainnetWarning');
                if (warning) warning.remove();

                showMessage('Wallet disconnected successfully', 'success');

            } catch (error) {
                console.error('Disconnect error:', error);
                showMessage(`Disconnect failed: ${error.message}`, 'error');
            }
        }

        function updateUI() {
            if (userAccount) {
                document.getElementById('status').textContent = `Connected via ${connectedWallet}`;
                document.getElementById('status').className = 'status connected';
                document.getElementById('userAddress').textContent = userAccount;

                // Hide wallet selection and show connected actions
                document.getElementById('walletSelection').style.display = 'none';
                document.getElementById('connectedActions').style.display = 'grid';

                // Enable transaction buttons
                const buttons = ['transferBtn', 'approveBtn', 'checkAllowanceBtn'];
                buttons.forEach(id => document.getElementById(id).disabled = false);
            } else {
                document.getElementById('status').textContent = 'Not Connected to Wallet';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('userAddress').textContent = 'Not Connected';

                // Show wallet selection and hide connected actions
                document.getElementById('walletSelection').style.display = 'block';
                document.getElementById('connectedActions').style.display = 'none';

                // Disable transaction buttons
                const buttons = ['transferBtn', 'approveBtn', 'checkAllowanceBtn'];
                buttons.forEach(id => document.getElementById(id).disabled = true);
            }
        }

        async function refreshData() {
            if (!contract || !userAccount) return;

            try {
                // Get token info
                const [balance, totalSupply, nonce, name, symbol, decimals, votingPower, delegates] = await Promise.all([
                    contract.balanceOf(userAccount),
                    contract.totalSupply(),
                    contract.nonces(userAccount),
                    contract.name(),
                    contract.symbol(),
                    contract.decimals(),
                    contract.getVotes(userAccount),
                    contract.delegates(userAccount)
                ]);

                // Format and display
                const formattedBalance = ethers.formatUnits(balance, decimals);
                const formattedTotalSupply = ethers.formatUnits(totalSupply, decimals);
                const formattedVotingPower = ethers.formatUnits(votingPower, decimals);

                document.getElementById('balance').textContent = `${parseFloat(formattedBalance).toLocaleString()} ${symbol}`;
                document.getElementById('totalSupply').textContent = `${parseFloat(formattedTotalSupply).toLocaleString()} ${symbol}`;
                document.getElementById('nonce').textContent = nonce.toString();
                document.getElementById('votingPower').textContent = `${parseFloat(formattedVotingPower).toLocaleString()} ${symbol}`;

                const el = document.getElementById("delegates");

                let displayDelegate;
                if (delegates === ethers.ZeroAddress) {
                    displayDelegate = "No delegate set";
                } else if (delegates.toLowerCase() === userAccount.toLowerCase()) {
                    displayDelegate = "Self-delegated";
                } else {
                    displayDelegate = delegates;
                }
                el.textContent = displayDelegate;
                // Toggle the class only if it's an address
                if (ethers.isAddress(displayDelegate)) {
                    el.classList.add("contract-info");
                } else {
                    el.classList.remove("contract-info");
                }

                showMessage('Data refreshed successfully!', 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showMessage(`Failed to refresh data: ${error.message}`, 'error');
            }
        }

        async function transferTokens() {
            const to = document.getElementById('transferTo').value;
            const amount = document.getElementById('transferAmount').value;

            if (!to || !amount) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount, decimals);

                showMessage('Transaction pending... Please confirm in MetaMask', 'success');
                const tx = await contract.transfer(to, amountWei);

                showMessage('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showMessage(`Transfer successful! Tx: ${tx.hash}`, 'success');
                await refreshData();

                // Clear inputs
                document.getElementById('transferTo').value = '';
                document.getElementById('transferAmount').value = '';

            } catch (error) {
                console.error('Transfer error:', error);
                showMessage(`Transfer failed: ${error.message}`, 'error');
            }
        }

        async function approveTokens() {
            const spender = document.getElementById('approveSpender').value;
            const amount = document.getElementById('approveAmount').value;

            if (!spender || !amount) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount, decimals);

                showMessage('Transaction pending... Please confirm in MetaMask', 'success');
                const tx = await contract.approve(spender, amountWei);

                showMessage('Transaction submitted! Waiting for confirmation...', 'success');
                await tx.wait();

                showMessage(`Approval successful! Tx: ${tx.hash}`, 'success');

                // Clear inputs
                document.getElementById('approveSpender').value = '';
                document.getElementById('approveAmount').value = '';

            } catch (error) {
                console.error('Approval error:', error);
                showMessage(`Approval failed: ${error.message}`, 'error');
            }
        }

        async function checkAllowance() {
            const owner = document.getElementById('allowanceOwner').value || userAccount;
            const spender = document.getElementById('allowanceSpender').value;

            if (!spender) {
                showMessage('Please enter spender address', 'error');
                return;
            }

            try {
                const allowance = await contract.allowance(owner, spender);
                const decimals = await contract.decimals();
                const symbol = await contract.symbol();
                const formattedAllowance = ethers.formatUnits(allowance, decimals);

                document.getElementById('allowanceResult').innerHTML = `
                    <div class="success">
                        Allowance: ${parseFloat(formattedAllowance).toLocaleString()} ${symbol}
                    </div>
                `;
            } catch (error) {
                console.error('Allowance check error:', error);
                showMessage(`Failed to check allowance: ${error.message}`, 'error');
            }
        }

        async function delegateVotingPower() {
            const delegatee = document.getElementById('delegateAddress').value || userAccount;

            if (!ethers.isAddress(delegatee)) {
                showMessage('Invalid delegatee address', 'error');
                return;
            }

            try {
                document.getElementById('delegateBtn').disabled = true;
                showMessage('Sending delegation transaction...', 'info');

                const tx = await contract.delegate(delegatee);
                await tx.wait();

                document.getElementById('delegateResult').innerHTML = `
            <div class="success">
                Successfully delegated to <code>${delegatee}</code><br />
                TX Hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a>
            </div>
        `;
                showMessage('Delegation successful!', 'success');
            } catch (error) {
                console.error('Delegation error:', error);
                showMessage(`Delegation failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('delegateBtn').disabled = false;
            }
        }

        async function checkVotingPower() {
            const address = document.getElementById('votingPowerAddress').value || userAccount;

            if (!ethers.isAddress(address)) {
                showMessage('Invalid address', 'error');
                return;
            }

            try {
                document.getElementById('checkVotingPowerBtn').disabled = true;
                showMessage('Fetching voting power...', 'info');

                const votes = await contract.getVotes(address);
                const decimals = await contract.decimals();
                const symbol = await contract.symbol();
                const formattedVotes = ethers.formatUnits(votes, decimals);

                document.getElementById('votingPowerResult').innerHTML = `
            <div class="success">
                Voting Power: ${parseFloat(formattedVotes).toLocaleString()} ${symbol}
            </div>
        `;
                showMessage('Voting power retrieved!', 'success');
            } catch (error) {
                console.error('Voting power error:', error);
                showMessage(`Failed to fetch voting power: ${error.message}`, 'error');
            } finally {
                document.getElementById('checkVotingPowerBtn').disabled = false;
            }
        }

        async function signAndSubmitPermit() {
            const spender = document.getElementById('permitSpenderAddress').value.trim();
            const amountStr = document.getElementById('permitAmount').value.trim();
            const deadlineStr = document.getElementById('deadlineStr').value.trim(); // <input type="datetime-local">

            // Basic validations
            if (!ethers.isAddress(spender)) {
                showMessage('Invalid permit spender address', 'error');
                return;
            }
            if (!amountStr || isNaN(Number(amountStr)) || Number(amountStr) <= 0) {
                showMessage('Enter a valid amount', 'error');
                return;
            }
            if (!deadlineStr) {
                showMessage('Please choose a deadline (date & time)', 'error');
                return;
            }

            try {
                // Disable button + info
                const btn = document.getElementById('signAndSubmitBtn');
                btn.disabled = true;
                showMessage('Signing permit and sending transaction‚Ä¶', 'info');

                // Gather data
                const [decimals, name, tokenAddress, nonce, network] = await Promise.all([
                    contract.decimals(),
                    contract.name(),
                    contract.getAddress(),
                    contract.nonces(userAccount),
                    provider.getNetwork()
                ]);

                const value = ethers.parseUnits(amountStr, decimals);

                // Convert local datetime to UNIX seconds
                const deadlineMs = new Date(deadlineStr).getTime();
                if (Number.isNaN(deadlineMs)) {
                    showMessage('Invalid deadline format', 'error');
                    btn.disabled = false;
                    return;
                }
                const deadline = Math.floor(deadlineMs / 1000);
                const nowSec = Math.floor(Date.now() / 1000);
                if (deadline <= nowSec) {
                    showMessage('Deadline must be in the future', 'error');
                    btn.disabled = false;
                    return;
                }

                // EIP-712 domain/types/message
                const domain = {
                    name,
                    version: '1', // OpenZeppelin ERC20Permit default
                    chainId: Number(network.chainId),
                    verifyingContract: tokenAddress
                };

                const types = {
                    Permit: [
                        { name: 'owner', type: 'address' },
                        { name: 'spender', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' }
                    ]
                };

                const message = {
                    owner: userAccount,
                    spender,
                    value,
                    nonce,
                    deadline
                };

                // Ask wallet to sign typed data (EIP-712)
                const signature = await signer.signTypedData(domain, types, message);
                const { v, r, s } = ethers.Signature.from(signature);

                // Submit permit on-chain
                const tx = await contract.permit(userAccount, spender, value, deadline, v, r, s);
                await tx.wait();

                // Optional: build an explorer link (main chains only)
                const chainId = Number(network.chainId);
                const explorerByChain = {
                    1: 'https://etherscan.io/tx/',
                    5: 'https://goerli.etherscan.io/tx/',
                    11155111: 'https://sepolia.etherscan.io/tx/',
                    137: 'https://polygonscan.com/tx/',
                    10: 'https://optimistic.etherscan.io/tx/',
                    8453: 'https://basescan.org/tx/',
                    42161: 'https://arbiscan.io/tx/',
                    ARBITRUM_SEPOLIA_CHAIN_ID: 'https://sepolia.arbiscan.io/'
                };
                const explorer = explorerByChain[chainId];

                document.getElementById('signAndSubmitResult').innerHTML = `
            <div class="success">
                Permit submitted successfully for <code>${spender}</code><br/>
                ${explorer
                        ? `TX Hash: <a href="${explorer}${tx.hash}" target="_blank" rel="noopener">${tx.hash}</a>`
                        : `TX Hash: ${tx.hash}`
                    }
            </div>
        `;
                showMessage('Permit successful! Allowance has been set via signature.', 'success');
            } catch (error) {
                console.error('Permit error:', error);
                showMessage(`Permit failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('signAndSubmitBtn').disabled = false;
            }
        }

        async function addTokenToWallet() {
            try {
                const [symbol, decimals] = await Promise.all([
                    contract.symbol(),
                    contract.decimals()
                ]);

                if (connectedWallet === 'MetaMask' && window.ethereum.request) {
                    await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: CONTRACT_ADDRESS,
                                symbol: symbol,
                                decimals: decimals,
                            },
                        },
                    });
                    showMessage(`Token added to ${connectedWallet}!`, 'success');
                } else {
                    showMessage(`Manual token import: Address: ${CONTRACT_ADDRESS}, Symbol: ${symbol}, Decimals: ${decimals}`, 'success');
                }
            } catch (error) {
                console.error('Add token error:', error);
                showMessage(`Failed to add token: ${error.message}`, 'error');
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);

            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Utility
        const nowPlusMins = (m) => new Date(Date.now() + m * 60 * 1000);
        const toUnix = (d) => Math.floor(d.getTime() / 1000);


        function defaultPermitDeadline() {
            // +60 minutes by default
            const dt = nowPlusMins(60);
            // to local datetime-local formatted string
            const pad = (n) => String(n).padStart(2, '0');
            const yyyy = dt.getFullYear();
            const mm = pad(dt.getMonth() + 1);
            const dd = pad(dt.getDate());
            const hh = pad(dt.getHours());
            const mi = pad(dt.getMinutes());
            return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
        }


        // Listen for account changes with error handling
        if (typeof window.ethereum !== 'undefined') {
            // Wrap event listeners in try-catch to handle origin errors
            try {
                window.ethereum.on('accountsChanged', function (accounts) {
                    if (accounts.length === 0 || !userAccount) {
                        disconnectWallet();
                    } else if (connectedWallet === 'MetaMask') {
                        setTimeout(() => connectMetaMask(), 100);
                    }
                });

                window.ethereum.on('chainChanged', function (chainId) {
                    // Detect new network and reconnect
                    setTimeout(async () => {
                        try {
                            if (connectedWallet === 'MetaMask') {
                                await connectMetaMask();
                            }
                        } catch (error) {
                            console.warn('Auto-reconnect failed:', error);
                        }
                    }, 100);
                });
            } catch (error) {
                console.warn('Event listener setup failed:', error);
            }
        }

        // Auto-connect if previously connected
        window.addEventListener('load', async function () {
            // Add delay to ensure page is fully loaded
            await new Promise(resolve => setTimeout(resolve, 500));

            // Try to auto-connect MetaMask if available and previously connected
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        setTimeout(() => connectMetaMask(), 200);
                    }
                } catch (error) {
                    console.warn('Auto-connect check failed:', error);
                }
            }

            // Initialize default UI state
            updateUI();
            document.getElementById('contractAddress').textContent = 'Connect wallet to view';
        });
    </script>
</body>

</html>